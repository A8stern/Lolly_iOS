#!/bin/bash

# –ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞ Xcode, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω
readonly PROJECT_FILE="LOLLY.xcodeproj"

# –§—É–Ω–∫—Ü–∏—è –≤—ã–≤–æ–¥–∞ —Å–ø—Ä–∞–≤–∫–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å–∫—Ä–∏–ø—Ç–∞
showHelp() {
  cat << EOF  
  
  *–ë–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤*    –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

  -h, -help, --help   –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É

  --full              –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –∑–∞–∫—Ä—ã—Ç—å Xcode –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –∑–∞–Ω–æ–≤–æ

  --generate          –¢–æ–ª—å–∫–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å XcodeGen –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

EOF
}

# –ó–∞–ø—É—Å–∫ XcodeGen ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç .xcodeproj –∏–∑ project.yml
runXcodeGen() {
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–æ–µ–∫—Ç–Ω—ã–π —Ñ–∞–π–ª
  if [ -d "$PROJECT_FILE" ]; then
    echo "–£–¥–∞–ª—è—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π $PROJECT_FILE..."
    rm -rf "$PROJECT_FILE"   # –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ–º –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
  else
   echo "$PROJECT_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫–∞—é —É–¥–∞–ª–µ–Ω–∏–µ."
  fi

  # –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ project.yml
  xcodegen -s project.yml
}

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Homebrew (–º–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–∫–µ—Ç–æ–≤), –µ—Å–ª–∏ –æ–Ω –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
installBrew() {
  if which brew >/dev/null; then
    echo "üü¢ Brew —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
  else
    # –°–∫–∞—á–∏–≤–∞–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Homebrew
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    # –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä ARM (–Ω–∞–ø—Ä–∏–º–µ—Ä, M1/M2), –¥–æ–±–∞–≤–ª—è–µ–º Brew –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    if [[ "$(arch -arm64 uname -m)" == "arm64" ]]; then
      echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> /Users/$(id -un)/.zprofile
      eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
    echo "üü¢ Brew —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
  fi
}

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ XcodeGen —á–µ—Ä–µ–∑ brew
installXcodeGen() {
  brew install xcodegen
}

# –ü–∞—Ä—Å–µ—Ä –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
if [[ "$1" == "" ]]; then
    # –ï—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –Ω–∏ –æ–¥–∏–Ω –∞—Ä–≥—É–º–µ–Ω—Ç ‚Äî –≤—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É
    echo "üî¥ –ù–µ–≤–µ—Ä–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ -h –¥–ª—è –ø–æ–º–æ—â–∏"
    exit 1;
else
   # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
   for i in "$@"; do
    case "$i" in
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª –ø–æ–º–æ—â—å
        -h|-help|--help)
            showHelp
            exit 0
            ;;

        # –ü–æ–ª–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞: –∑–∞–∫—Ä—ã–≤–∞–µ–º Xcode, —Å—Ç–∞–≤–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç
        --full)
            kill $(ps aux | grep 'Xcode')   # –ó–∞–∫—Ä—ã–≤–∞–µ–º Xcode, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            installBrew                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Homebrew
            installXcodeGen               # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º XcodeGen
            runXcodeGen                   # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
            open "$PROJECT_FILE"          # –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–µ–∫—Ç –≤ Xcode
            ;;
        # –¢–æ–ª—å–∫–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Brew –∏ XcodeGen
        --generate)
            runXcodeGen
            ;;
        # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –Ω–µ–≤–µ—Ä–Ω—ã–º–∏
        *)
            echo "üî¥ –ù–µ–≤–µ—Ä–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ -h –¥–ª—è –ø–æ–º–æ—â–∏"
            exit 1
            ;;
    esac
  done
fi